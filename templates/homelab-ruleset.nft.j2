#!/usr/sbin/nft -f

flush ruleset

#requires testing
table inet filter {
        define lan_subnet = 192.168.0.0/24
        define loki_server = "{{ hostvars['loki'].ansible_host | ansible.utils.ipv4 }}"
        define prometheus_server = "{{ hostvars['prometheus'].ansible_host | ansible.utils.ipv4 }}"
        chain INPUT {
            type filter hook input priority filter
            # drop all be default
            policy drop
            # Accept packets in established and related state, drop invalid packets
            ct state vmap { established:accept, related:accept, invalid:drop }
            # allow loopback
            iifname lo accept
            # allow ssh connections from inside lan subnet 
            tcp saddr $lan_subnet dport ssh accept
            # rate limit pings
            meta l4proto icmp icmp type echo-request limit rate over 10/second burst 4 packets drop
        }
        chain OUTPUT {
                type filter hook output priority filter
                policy accept
                # drop invalid packets
                ct state invalid drop
                # drop promtail packets if not goignt to loki as otherwise they are exposed 
                tcp dport 3100 daddr !$loki_server drop
                tcp dport 9100 daddr !$prometheus_server drop
                meta l4proto {tcp, udp} th sport 53 daddr 1$lan_subnet drop
        }

}