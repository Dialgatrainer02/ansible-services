---
# tasks file for service_setup
- name: install packages
  ansible.builtin.dnf:
    name:
      - nano
      - openssh-server
      - curl
      - git
      - tar
    state: latest
- name: make user 
  ansible.builtin.user:
    name: "{{ service_setup_user }}"
    password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          37356236306131313365656531313737326639616566363337663039656562613334313865646630
          6533613963336262316235666339323536373735316337620a366439303766343232383338623165
          65613761623531643935316638353133666131346662303964303737306562316235393965396164
          6133666335643663650a646663373338353263363733633139383135306162666662333665376134
          64633566306431383162366566396663653736316261636661333131303265663963
    groups:
      - wheel
    create_home: true
    state: present
- name: install promtail
  ansible.builtin.include_role:
    name: promtail
  tags:
    - promtail
  vars:
    promtail_config_scrape_configs:
      - job_name: journal
        journal:
          json: false
          max_age: 12h
          path: "/run/log/journal/{{ hostvars[inventory_hostname].ansible_machine_id }}/"
          labels:
            job: systemd-journal
        relabel_configs:
        # make a clean label name without '.service'
        - action: 'replace'
          source_labels: ['__journal__systemd_unit']
          regex: '(.*?)\.service'
          replacement: '\$1'
          target_label: 'unit'
- name: install node_exporter
  ansible.builtin.include_role:
    name: node_exporter
  tags:
    - node-exporter 
