- name: install matrics and log exporters
  hosts: all
  become: true
  roles:
    - role: node_exporter
      tags:
        - node_exporter
    - role: promtail
      tags:
        - promtail
      vars:
        promtail_loki_server_url: "http://{{ hostvars['loki'].ansible_host | ansible.utils.ipv4 }}:3100"
        promtail_config_scrape_configs:
        - job_name: journal
          journal:
            json: false
            max_age: 12h
            path: "/run/log/journal/{{ hostvars[inventory_hostname].ansible_machine_id }}/"
            labels:
              job: "systemd-journal"
              node: "{{ inventory_hostname }}"
          relabel_configs: # todo seperate per instance logging and get nice relabel configs
            - action: keep
              source_labels:
                - __journal__systemd_unit
              target_label: unit!
  post_tasks:
    - name: reload promtail
      ansible.builtin.systemd_service:
        name: promtail
        state: restarted
      ignore_errors: true
      tags:
        - promtail

- name: install and setup prometheus
  hosts: prometheus
  roles:
  - prometheus.prometheus.prometheus
  post_tasks:
    - name: add file sd targets
      ansible.builtin.template:
        src: "../templates/targets.yml.j2"
        dest: "/etc/prometheus/file_sd/node.yml" 
      tags:
        - prometheus
        - service_discovery
  tags:
    - prometheus
- name: install and setup loki
  hosts: loki
  roles:
    - role: loki
  tags:
    - loki
- name: install and setup granfana
  hosts: grafana
  roles:
    - role: grafana.grafana.grafana
  vars:
    grafana_security:
      admin_user: olivia
      admin_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36383833386262333733393430663632653331633063363134376535316232613438333331323535
          3832333433343833376263656131633737613762336666660a356161333331666338363165383163
          62303631373938646532623133393030313866353434663839623333626266303236366433363363
          3961323536386637340a343065333633303630663362353764643832376666346138393965323338
          65623437666665633162303163613064353565613530646435653537323366366438
    grafana_datasources:
      - name: prometheus
        type: prometheus
        access: proxy
        url: 'http://{{ hostvars["prometheus"].ansible_host | ansible.utils.ipv4 }}:9090'
        basicAuth: false
      - name: loki
        type: loki
        access: proxy
        url: 'http://{{ hostvars["loki"].ansible_host | ansible.utils.ipv4 }}:3100'
        basicAuth: false
    grafana_dashboards:
      - dashboard_id: 1860
        revision_id: 37
        datasource: prometheus
    grafana_alerting: {}
  tags:
    - grafana